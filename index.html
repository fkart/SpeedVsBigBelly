<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ball Race Simulation</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;flex-direction:column;align-items:center;padding:20px;min-height:100vh}
h1{color:#fff;margin-bottom:20px}
button{padding:10px 20px;font-size:16px;margin:10px;cursor:pointer;background:#f093fb;color:#fff;border:none;border-radius:5px;transition:transform 0.1s}
button:hover{transform:scale(1.05)}
button:active{transform:scale(0.95)}
#winner{color:#fff;font-size:24px;font-weight:bold;margin:10px}
.controls{margin:10px}
.container{display:flex;gap:20px;margin-top:20px;position:relative;justify-content:center;align-items:flex-start}
.box{background:rgba(255,255,255,0.8);border-radius:15px;padding:20px;position:relative;flex-shrink:0}
.timeline-box{background:rgba(0,0,0,0.3);border-radius:15px;padding:15px 10px;width:360px;height:740px;flex-shrink:0;display:flex;flex-direction:column}
.title{text-align:center;font-size:18px;font-weight:bold;margin-bottom:10px;padding:10px;border-radius:8px;color:#fff}
.t1{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.t2{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
canvas{border:3px solid #333;background:#f8f9fa;border-radius:8px;display:block;touch-action:none}
#confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;background:transparent}
.stats{padding:10px;background:#f8f9fa;border-radius:8px;font-size:14px}
.row{display:flex;justify-content:space-between;margin:5px 0}
.lbl{font-weight:bold;color:#555}
.progress-bar{width:300px;height:20px;background:#ddd;border-radius:10px;overflow:hidden;margin:5px 0;position:relative}
.progress-fill{height:100%;transition:width 0.3s;border-radius:10px}
.progress-p1{background:linear-gradient(90deg,#667eea,#764ba2)}
.progress-p2{background:linear-gradient(90deg,#f093fb,#f5576c)}
.progress-text{position:absolute;width:100%;text-align:center;line-height:20px;font-size:12px;font-weight:bold;color:#333}
.scoreboard{color:#fff;font-size:16px;margin:10px;padding:15px;background:rgba(0,0,0,0.3);border-radius:10px;display:flex;gap:60px;justify-content:center;position:relative;user-select:none}
.score-item{text-align:center;position:relative}
.score-num{font-size:28px;font-weight:bold}
.winner-badge{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:10}
.winner-badge.show{opacity:1}
.crit-flash{animation:critFlash 0.3s}
@keyframes critFlash{0%,100%{background:#f8f9fa}50%{background:#ffd700}}
.powerup{position:absolute;top:45px;right:10px;background:linear-gradient(135deg,#FF6B6B,#FFD93D);color:#fff;padding:8px 12px;border-radius:8px;font-weight:bold;font-size:14px;display:none;box-shadow:0 4px 8px rgba(0,0,0,0.3);animation:powerupPulse 0.5s infinite;user-select:none}
@keyframes powerupPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.card-hand{position:absolute;top:-30px;right:15px;display:flex;gap:3px;z-index:100}
.card-item{width:25px;height:35px;background:linear-gradient(135deg,#FFD700,#FFA500);border:2px solid #000;border-radius:0 0 4px 4px;box-shadow:0 3px 6px rgba(0,0,0,0.4),0 5px 15px rgba(0,0,0,0.25);transition:all 0.3s;position:relative;cursor:pointer;touch-action:manipulation}
.card-item:hover{transform:translateY(-3px) scale(1.1)!important}
.card-item .tooltip{visibility:hidden;opacity:0;position:absolute;bottom:100%;left:50%;transform:translateX(-50%) translateY(-5px);background:rgba(0,0,0,0.95);color:#fff;padding:8px 12px;border-radius:8px;font-size:11px;white-space:nowrap;z-index:1000;transition:opacity 0.2s,visibility 0.2s;pointer-events:none;box-shadow:0 4px 12px rgba(0,0,0,0.5);max-width:200px;white-space:normal;text-align:center;line-height:1.3}
.card-item .tooltip:after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:rgba(0,0,0,0.95)}
.card-item:hover .tooltip,.card-item.show-tooltip .tooltip{visibility:visible;opacity:1}
.card-item:nth-child(1){transform:rotate(-8deg)}
.card-item:nth-child(2){transform:rotate(-4deg)}
.card-item:nth-child(3){transform:rotate(0deg)}
.card-item:nth-child(4){transform:rotate(4deg)}
.card-item:nth-child(5){transform:rotate(8deg);background:linear-gradient(135deg,#FF1493,#FF69B4,#FFD700);border:3px solid #FFD700;box-shadow:0 0 15px rgba(255,215,0,0.8),0 3px 6px rgba(0,0,0,0.4),0 5px 15px rgba(0,0,0,0.25);animation:specialGlow 2s ease-in-out infinite}
@keyframes specialGlow{0%,100%{box-shadow:0 0 15px rgba(255,215,0,0.8),0 3px 6px rgba(0,0,0,0.4),0 5px 15px rgba(0,0,0,0.25)}50%{box-shadow:0 0 25px rgba(255,215,0,1),0 3px 6px rgba(0,0,0,0.4),0 5px 15px rgba(0,0,0,0.25)}}
.card-item.used{opacity:0;transform:translateY(-20px) scale(0.5) !important;pointer-events:none}
.timeline-center{color:#fff;font-size:10px;height:100%;overflow:hidden;display:flex;flex-direction:column}
.timeline-center h3{margin:0 0 12px 0;font-size:16px;text-align:center;border-bottom:2px solid #FFD700;padding-bottom:6px;color:#FFD700;flex-shrink:0}
.timeline-content{position:relative;flex:1;padding:10px 20px;overflow-y:auto}
.timeline-item{position:relative;margin:8px 0;padding:8px 10px;border-radius:12px;font-size:10px;line-height:1.4;white-space:normal;word-wrap:break-word;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:grid;grid-template-columns:50px 1fr;gap:10px;align-items:center;max-width:280px}
.timeline-p1{background:linear-gradient(135deg,rgba(102,126,234,0.9),rgba(118,75,162,0.9));margin-left:0;margin-right:auto}
.timeline-p1 .timeline-content{text-align:center}
.timeline-p2{background:linear-gradient(135deg,rgba(240,147,251,0.9),rgba(245,87,108,0.9));margin-left:auto;margin-right:0}
.timeline-p2 .timeline-content{text-align:center}
.timeline-win{background:linear-gradient(135deg,rgba(255,215,0,0.95),rgba(255,193,7,0.95));text-align:center;margin-left:auto;margin-right:auto;max-width:320px}
.timeline-win .timeline-content{text-align:center;font-size:11px;font-weight:bold}
.timeline-time{color:#FFD700;font-weight:bold;font-size:9px;text-shadow:0 1px 2px rgba(0,0,0,0.5);text-align:left}
.container{position:relative}
.card-reveal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);width:450px;min-height:250px;padding:30px;background:rgba(0,0,0,0.95);border-radius:15px;border:3px solid #fff;color:#fff;text-align:center;z-index:10000;transition:transform 0.3s,opacity 0.3s;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:none}
.card-reveal.show{transform:translate(-50%,-50%) scale(1);display:block}
.card-reveal h2{font-size:28px;margin:0 0 12px 0;line-height:1.2}
.card-reveal p{font-size:16px;margin:8px 0;line-height:1.4}
.card-reveal .effect{font-size:18px;font-weight:bold;margin:12px 0;padding:12px;border-radius:8px;background:rgba(255,255,255,0.1);line-height:1.3}
#commentary{position:fixed;top:280px;left:50%;padding:15px 20px;border-radius:20px;font-size:14px;font-weight:bold;z-index:10000;opacity:0;transition:opacity 0.3s,transform 0.3s;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,0.4);max-width:350px;text-align:center;line-height:1.4;border:3px solid rgba(255,255,255,0.3)}
#commentary.p1-bubble{transform:translateX(-50%) translateX(-30px) translateY(-10px);background:linear-gradient(135deg,#667eea,#5a67d8);color:#fff}
#commentary.p2-bubble{transform:translateX(-50%) translateX(30px) translateY(-10px);background:linear-gradient(135deg,#f5576c,#f093fb);color:#fff}
#commentary.system-banner{transform:translateX(-50%) translateY(-10px);background:linear-gradient(135deg,#FFD700,#FFA500);color:#000;text-align:center;border-radius:12px;text-shadow:none;border-color:#FFA500}
#commentary.show{opacity:1}
#commentary.p1-bubble.show{transform:translateX(-50%) translateX(-30px) translateY(0)}
#commentary.p2-bubble.show{transform:translateX(-50%) translateX(30px) translateY(0)}
#commentary.system-banner.show{transform:translateX(-50%) translateY(0)}
@media (max-width: 768px){
body{padding:2px;overflow-x:auto}
h1{font-size:18px;margin-bottom:8px}
table{width:360px!important;border-collapse:collapse;margin:0 auto}
table tr:first-child{display:block;width:100%}
table tr:first-child td{display:block;width:100%!important;padding:5px!important}
table tr:first-child td:first-child .stats,table tr:first-child td:last-child .stats{display:none}
table tr:first-child td:first-child .title,table tr:first-child td:last-child .title{display:none}
table tr:first-child td .box{padding:0;background:transparent!important}
table tr:nth-child(2){display:table-row}
table tr:nth-child(2) td{padding:2px 1px!important;vertical-align:top!important;display:table-cell!important}
table tr:nth-child(2) td:nth-child(1){width:110px!important}
table tr:nth-child(2) td:nth-child(2){width:130px!important}
table tr:nth-child(2) td:nth-child(3){width:110px!important}
.box{padding:5px;margin:0}
.title{font-size:12px;padding:4px;margin-bottom:4px}
canvas{width:102px!important;height:400px!important}
.card-hand{top:-5px;right:2px;gap:1px}
.card-item{width:15px;height:24px}
.scoreboard{padding:8px 10px!important;gap:25px!important;font-size:14px}
.score-num{font-size:20px}
#timerBox{min-width:80px;height:22px;font-size:12px;padding:1px 6px}
#pauseBtn{min-width:24px;height:16px;font-size:12px}
#commentary{max-width:180px;font-size:9px;padding:6px 8px;top:60px}
.card-reveal{width:85vw;max-width:300px;padding:12px;min-height:150px}
.card-reveal h2{font-size:16px;margin:0 0 8px 0}
.card-reveal p{font-size:11px;margin:4px 0}
.card-reveal .effect{font-size:13px;margin:8px 0;padding:8px}
.timeline-box{width:130px!important;height:500px;padding:5px 3px}
.timeline-content{padding:4px 5px}
.timeline-item{font-size:8px;padding:4px 5px;max-width:120px;grid-template-columns:30px 1fr}
.timeline-time{font-size:7px}
.powerup{font-size:7px;padding:3px 5px;top:0px;right:1px;max-width:90px}
}
@media (max-width: 480px){
h1{font-size:14px;margin-bottom:5px}
body{padding:0 3px!important;margin:0!important;overflow-x:hidden!important}
table{width:100%!important;table-layout:fixed;margin:0!important;border-spacing:0!important}
table tr:first-child{display:table-row!important}
table tr:first-child td{display:table-cell!important;padding:2px 1px!important;vertical-align:top!important}
table tr:first-child td:first-child{width:23%!important}
table tr:first-child td:nth-child(2){width:54%!important}
table tr:first-child td:last-child{width:23%!important}
table tr:first-child td .box{background:transparent!important}
table tr:first-child td:first-child .title,table tr:first-child td:last-child .title{display:block!important}
table tr:first-child td:first-child .stats,table tr:first-child td:last-child .stats{display:block!important}
table tr:nth-child(2) td{padding:0!important;vertical-align:top!important}
table tr:nth-child(2) td:nth-child(1){width:23%!important}
table tr:nth-child(2) td:nth-child(2){width:54%!important}
table tr:nth-child(2) td:nth-child(3){width:23%!important}
.box{padding:3px!important;margin:0!important;border-radius:8px!important;background:rgba(255,255,255,0.8)!important;border:none!important}
.stats{padding:4px 2px!important;background:#f8f9fa!important;border-radius:5px;font-size:7px}
.stats table{font-size:7px!important}
.stats td,.stats .lbl{padding:1px!important;font-size:7px!important}
.title{font-size:8px;padding:2px;margin-bottom:2px;border-radius:5px}
canvas{width:100%!important;height:280px!important;display:block;border:none!important;border-radius:8px!important;background:transparent!important}
.card-hand{top:-3px;right:0px;gap:0px}
.card-item{width:8px;height:14px;border-width:1px}
.scoreboard{gap:8px!important;padding:3px 4px!important;font-size:9px}
.score-num{font-size:14px}
#timerBox{min-width:50px;height:15px;font-size:8px;padding:1px 3px}
#pauseBtn{min-width:15px;height:10px;font-size:8px}
#commentary{max-width:140px;font-size:7px;padding:4px 6px;top:50px}
.timeline-box{width:100%!important;height:360px;padding:5px!important;background:rgba(0,0,0,0.3)!important;border-radius:8px}
.timeline-content{padding:3px 2px}
.timeline-item{font-size:6px;padding:3px;grid-template-columns:18px 1fr;margin:4px 0}
.timeline-time{font-size:6px}
.powerup{font-size:6px;padding:2px 3px;top:0px;right:0px;max-width:80px}
.card-reveal{width:80vw;max-width:280px;padding:10px;min-height:120px}
.card-reveal h2{font-size:14px;margin:0 0 6px 0}
.card-reveal p{font-size:10px;margin:3px 0}
.card-reveal .effect{font-size:12px;margin:6px 0;padding:6px}
}
</style>
</head>
<body>
<canvas id="confetti"></canvas>
<div class="card-reveal" id="cardReveal">
<h2 id="revealTitle"></h2>
<p id="revealPlayer"></p>
<div class="effect" id="revealEffect"></div>
<p id="revealDescription"></p>
</div>
<div id="commentary"></div>
<h1>Speed or Power</h1>
<table style="border-collapse:collapse;margin:10px auto">
<tr>
<td style="width:340px;vertical-align:top;padding:0 10px">
<div class="box">
<div class="title t1" style="margin-bottom:10px">Speedy</div>
<div class="stats">
<table style="width:100%;border-collapse:collapse">
<tr>
<td class="lbl" style="padding:3px 8px;text-align:center">Speed</td>
<td class="lbl" style="padding:3px 8px;text-align:center">Damage</td>
<td class="lbl" style="padding:3px 8px;text-align:center">Bounces</td>
</tr>
<tr>
<td style="padding:3px 8px;text-align:center" id="sp1">1.00x</td>
<td style="padding:3px 8px;text-align:center" id="dm1">15</td>
<td style="padding:3px 8px;text-align:center" id="bn1">0</td>
</tr>
</table>
</div>
</div>
</td>
<td style="width:240px;vertical-align:top;padding:0 10px">
<div class="box" style="padding:15px 8px">
<div style="display:flex;flex-direction:column;gap:0;align-items:center">
<div class="scoreboard" style="background:#fff;margin:0;padding:15px 20px;color:#333;box-shadow:0 4px 8px rgba(0,0,0,0.2),0 6px 20px rgba(0,0,0,0.15);border:1px solid #e0e0e0;position:relative;border-radius:10px 10px 0 0">
<div style="position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#667eea 0%,#667eea 50%,#f5576c 50%,#f5576c 100%);border-radius:10px 10px 0 0"></div>
<div style="display:flex;gap:60px;margin-top:8px;position:relative">
<div class="score-item">
<div class="winner-badge" id="winner1">üèÜ</div>
<div class="score-num" id="p1wins" style="color:#667eea">0</div>
</div>
<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:2px;height:40px;background:#ddd"></div>
<div class="score-item">
<div class="winner-badge" id="winner2">üèÜ</div>
<div class="score-num" id="p2wins" style="color:#f5576c">0</div>
</div>
</div>
</div>
<div style="display:flex;gap:8px;align-items:center;justify-content:center">
<div id="timerBox" style="color:#333;font-size:16px;padding:1px 10px;background:#fff;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,0.2),0 6px 20px rgba(0,0,0,0.15);border:1px solid #e0e0e0;border-radius:0 0 10px 10px;display:inline-flex;align-items:center;justify-content:center;font-weight:bold;gap:10px;min-width:110px;height:28px">
<span id="timerText" style="min-width:40px;text-align:center">10</span>
<button id="pauseBtn" onclick="togglePause()" style="padding:1px 8px;font-size:16px;cursor:pointer;background:#34495e;color:#fff;border:none;border-radius:6px;min-width:32px;height:20px;line-height:1">‚è∏</button>
</div>
</div>
<div style="width:100%;height:25px;background:rgba(255,255,255,0.2);border-radius:10px;overflow:hidden;position:relative;padding:2px;margin-top:8px">
<div style="position:relative;width:100%;height:100%;background:#ddd;border-radius:8px;overflow:hidden">
<div id="progbar1" style="position:absolute;left:0;top:0;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.3s;width:50%"></div>
<div id="progbar2" style="position:absolute;right:0;top:0;height:100%;background:linear-gradient(90deg,#f5576c,#f093fb);transition:width 0.3s;width:50%"></div>
<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:2px;height:100%;background:#333;z-index:1"></div>
<span style="position:absolute;left:8px;top:50%;transform:translateY(-50%);color:#fff;font-weight:bold;font-size:11px;z-index:2;text-shadow:0 1px 2px rgba(0,0,0,0.8)" id="progtext1">0%</span>
<span style="position:absolute;right:8px;top:50%;transform:translateY(-50%);color:#fff;font-weight:bold;font-size:11px;z-index:2;text-shadow:0 1px 2px rgba(0,0,0,0.8)" id="progtext2">0%</span>
</div>
</div>
</div>
</div>
</td>
<td style="width:340px;vertical-align:top;padding:0 10px">
<div class="box">
<div class="title t2" style="margin-bottom:10px">Big Belly</div>
<div class="stats">
<table style="width:100%;border-collapse:collapse">
<tr>
<td class="lbl" style="padding:3px 8px;text-align:center">Speed</td>
<td class="lbl" style="padding:3px 8px;text-align:center">Damage</td>
<td class="lbl" style="padding:3px 8px;text-align:center">Bounces</td>
</tr>
<tr>
<td style="padding:3px 8px;text-align:center" id="sp2">1.00x</td>
<td style="padding:3px 8px;text-align:center" id="dm2">15</td>
<td style="padding:3px 8px;text-align:center" id="bn2">0</td>
</tr>
</table>
</div>
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top;padding:10px 10px 0 10px">
<div class="box">
<div class="powerup" id="powerup1">POWER UP!</div>
<canvas id="c1" width="300" height="600"></canvas>
<div class="card-hand" id="cardHand1">
<div class="card-item" id="card1-0"></div>
<div class="card-item" id="card1-1"></div>
<div class="card-item" id="card1-2"></div>
<div class="card-item" id="card1-3"></div>
<div class="card-item" id="card1-4"></div>
</div>
</div>
</td>
<td style="vertical-align:top;padding:10px 10px 0 10px">
<div style="width:360px;height:740px;display:flex;flex-direction:column">
<div class="timeline-center" style="height:100%">
<div class="timeline-content" id="timelineCenter"></div>
</div>
</div>
</td>
<td style="vertical-align:top;padding:10px 10px 0 10px">
<div class="box">
<div class="powerup" id="powerup2">POWER UP!</div>
<canvas id="c2" width="300" height="600"></canvas>
<div class="card-hand" id="cardHand2">
<div class="card-item" id="card2-0"></div>
<div class="card-item" id="card2-1"></div>
<div class="card-item" id="card2-2"></div>
<div class="card-item" id="card2-3"></div>
<div class="card-item" id="card2-4"></div>
</div>
</div>
</td>
</tr>
</table>
<script>
var c1=document.getElementById('c1'),c2=document.getElementById('c2');
var ctx1=c1.getContext('2d'),ctx2=c2.getContext('2d');
var cf=document.getElementById('confetti'),ctxConf=cf.getContext('2d');
cf.width=window.innerWidth;cf.height=window.innerHeight;
var W=300,H=600,run=1,win='',startTime=Date.now(),gameTime=0;
var sp1=5,sp2=5;
var p1Wins=0,p2Wins=0,totalRaces=0;
var p1Cards=[],p2Cards=[];
var p1PowerupActive=false,p2PowerupActive=false;
var p1PowerupEnd=0,p2PowerupEnd=0;
var isPaused=false;
var countdown=0;
var countdownInterval=null;
var pauseStartTime=0;
var totalPausedTime=0;
var p1PowerupType='',p2PowerupType='';
var p1InstantCooldown=0,p2InstantCooldown=0;
var cardRevealQueue=[];
var isShowingCardReveal=false;
var p1CardsUsed=[false,false,false,false,false];
var p2CardsUsed=[false,false,false,false,false];
var CARD_MILESTONES=[[5,15],[25,35],[45,55],[65,75],[85,95]];
var b1={x:150,y:50,vx:0,vy:5,r:10,col:'#667eea',dmg:50,bounces:0,sm:1,type:'speed',lastY:50,stuckCount:0,totalDmg:0};
var b2={x:150,y:50,vx:0,vy:5,r:10,col:'#f5576c',dmg:50,bounces:0,sm:1,type:'grow',lastY:50,stuckCount:0,totalDmg:0};
var o1=[],o2=[],p1=[],p2=[],confettiArr=[];
var ceiling1=20,ceiling2=20,ceilingEnd1=0,ceilingEnd2=0;
var pendingSwap=false,swapInitiator=0;
var b1Stopped=false,b2Stopped=false,stopEnd1=0,stopEnd2=0;
var chaosActive=false,chaosEnd=0,chaosInitiator=0;
var originalTotalHp1=0,originalTotalHp2=0;
var lastCritTime1=0,lastCritTime2=0;
var closeRaceLogged=false;
var speedHistory1=[],speedHistory2=[];
var SPEED_SMOOTH_FRAMES=8;

function getRandomWinMessage(player,loser,timeDiff){
var messages=[
player+' destroyed '+loser+'! Absolute demolition! üî•',
player+' wins by '+timeDiff.toFixed(1)+'s. '+loser+' needs more cardio! üí™',
player+' crosses the line! '+loser+' still trying to find their way out! üèÜ',
'Victory for '+player+'! '+loser+' brought a spoon to a knife fight! üó°Ô∏è',
player+' wins! '+loser+' should\'ve read the tutorial! üìñ',
'Get wrecked, '+loser+'! '+player+' is the new champion! üëë',
player+' barely breaks a sweat. '+loser+' is sweating bullets! üí¶',
player+' wins! '+loser+', better luck next time... maybe! üé≤'
];
return messages[Math.floor(Math.random()*messages.length)];
}

function getCritReaction(){
var reactions=[
'BOOM! That hurt! üí•',
'CRITICAL HIT! Someone call 911! üöë',
'OUCH! That\'s gonna leave a mark! üò±',
'SMASH! The crowd goes wild! üéâ',
'WHAM! Did you see that?! üëÄ',
'KABOOM! Physics just exploded! ‚ö°',
'POW! That obstacle never saw it coming! üí´',
'CRUNCH! Savage damage! üî®'
];
return reactions[Math.floor(Math.random()*reactions.length)];
}

function getCloseRaceComment(diff){
if(diff<5){
return 'This is TIGHT! Only '+diff.toFixed(1)+'% difference! üî•';
}else if(diff<10){
return 'Getting close! '+diff.toFixed(1)+'% gap - anything can happen! ‚ö°';
}
return '';
}

var commentaryTimeout=null;
function showCommentary(message,source){
var commentaryBox=document.getElementById('commentary');
commentaryBox.textContent=message;
commentaryBox.className='';
if(source==='p1'){
commentaryBox.className='p1-bubble';
}else if(source==='p2'){
commentaryBox.className='p2-bubble';
}else{
commentaryBox.className='system-banner';
}
setTimeout(function(){
commentaryBox.classList.add('show');
},10);
if(commentaryTimeout)clearTimeout(commentaryTimeout);
commentaryTimeout=setTimeout(function(){
commentaryBox.classList.remove('show');
},3000);
}

function logEvent(message,type,cardType){
var time=(Date.now()-startTime)/1000;
var eventDiv=document.createElement('div');
eventDiv.className='timeline-item timeline-'+type;
var cardColors={
'boost':'linear-gradient(135deg,rgba(255,107,107,0.9),rgba(255,217,61,0.9))',
'curse':'linear-gradient(135deg,rgba(231,76,60,0.9),rgba(192,57,43,0.9))',
'sabotage':'linear-gradient(135deg,rgba(142,68,173,0.9),rgba(44,62,80,0.9))',
'fortify':'linear-gradient(135deg,rgba(39,174,96,0.9),rgba(34,153,84,0.9))',
'reflect':'linear-gradient(135deg,rgba(243,156,18,0.9),rgba(230,126,34,0.9))',
'swap':'linear-gradient(135deg,rgba(52,152,219,0.9),rgba(41,128,185,0.9))',
'pressure':'linear-gradient(135deg,rgba(233,30,99,0.9),rgba(136,14,79,0.9))',
'repair':'linear-gradient(135deg,rgba(22,160,133,0.9),rgba(26,188,156,0.9))',
'corrupt':'linear-gradient(135deg,rgba(149,165,166,0.9),rgba(127,140,141,0.9))',
'shrink':'linear-gradient(135deg,rgba(155,89,182,0.9),rgba(142,68,173,0.9))',
'chaos':'linear-gradient(135deg,rgba(230,126,34,0.9),rgba(211,84,0,0.9))',
'gravity':'linear-gradient(135deg,rgba(52,73,94,0.9),rgba(44,62,80,0.9))',
'heavygravity':'linear-gradient(135deg,rgba(26,26,46,0.9),rgba(22,33,62,0.9))',
'freeze':'linear-gradient(135deg,rgba(0,210,255,0.9),rgba(58,123,213,0.9))',
'rage':'linear-gradient(135deg,rgba(255,8,68,0.9),rgba(255,177,153,0.9))',
'timewarp':'linear-gradient(135deg,rgba(168,237,234,0.9),rgba(254,214,227,0.9))'
};
var persistentCards=['repair','corrupt','shrink','gravity'];
var instantCards=['fortify','reflect','swap','freeze'];
var durationIcon='';
if(cardType){
if(persistentCards.indexOf(cardType)!==-1){
durationIcon='<span style="color:#FFD700;font-weight:bold;margin-left:5px" title="Permanent effect">‚ö°</span>';
}else if(instantCards.indexOf(cardType)!==-1){
durationIcon='<span style="color:#87CEEB;font-weight:bold;margin-left:5px" title="Instant effect">‚ú¶</span>';
}else{
durationIcon='<span style="color:#FFA500;font-weight:bold;margin-left:5px" title="Temporary effect (5s)">‚è±</span>';
}
}
if(cardType&&cardColors[cardType]){
eventDiv.style.background=cardColors[cardType];
}
eventDiv.innerHTML='<span class="timeline-time">'+time.toFixed(1)+'s</span><div class="timeline-content">'+message+durationIcon+'</div>';
document.getElementById('timelineCenter').appendChild(eventDiv);
}

function generateCards(){
var regularCards=['boost','boost','sabotage','fortify','reflect','pressure','repair','shrink','gravity','heavygravity','curse','corrupt'];
var specialCards=['swap','stop','chaos','freeze','rage','timewarp'];
p1Cards=[];
p2Cards=[];
for(var i=0;i<4;i++){
p1Cards.push(regularCards[Math.floor(Math.random()*regularCards.length)]);
p2Cards.push(regularCards[Math.floor(Math.random()*regularCards.length)]);
}
p1Cards.push(specialCards[Math.floor(Math.random()*specialCards.length)]);
p2Cards.push(specialCards[Math.floor(Math.random()*specialCards.length)]);
p1CardsUsed=[false,false,false,false,false];
p2CardsUsed=[false,false,false,false,false];
updateCardDisplay();
}

function updateCardDisplay(){
var cardDescriptions={
'boost':'BOOST: 2.5x damage/speed for 5s',
'curse':'CURSE: 60% penalty for 5s (bad!)',
'sabotage':'SABOTAGE: Enemy 60% penalty for 5s',
'fortify':'FORTIFY: Obstacles lose 15% HP',
'reflect':'REFLECT: Swap active effects',
'swap':'SWAP: Exchange obstacles!',
'stop':'STOP: Freeze enemy 3s',
'pressure':'PRESSURE: Ceiling drops 200px for 5s',
'repair':'REPAIR: Enemy obstacles +300 HP',
'corrupt':'CORRUPT: Own obstacles -200 HP (bad!)',
'shrink':'SHRINK: Enemy ball -30% size',
'chaos':'CHAOS: Ball control swap 8s',
'gravity':'GRAVITY: +10% fall speed permanent',
'heavygravity':'HEAVY GRAVITY: +50% fall speed for 3s',
'freeze':'FREEZE ‚≠ê: Freeze enemy 5s',
'rage':'RAGE ‚≠ê: 3x damage + speed for 5s',
'timewarp':'TIME WARP ‚≠ê: 10x speed for 3s'
};
for(var i=0;i<5;i++){
var card1=document.getElementById('card1-'+i);
var card2=document.getElementById('card2-'+i);
if(card1){
if(p1CardsUsed[i]){
card1.classList.add('used');
card1.innerHTML='';
card1.onclick=null;
}else{
card1.classList.remove('used');
var cardIndex=i-(5-p1Cards.length);
if(cardIndex>=0&&cardIndex<p1Cards.length){
var cardType=p1Cards[cardIndex];
var desc=cardDescriptions[cardType]||cardType.toUpperCase();
card1.innerHTML='<div class="tooltip">'+desc+'</div>';
card1.onclick=(function(elem){
return function(e){
e.stopPropagation();
document.querySelectorAll('.card-item').forEach(function(c){c.classList.remove('show-tooltip')});
elem.classList.add('show-tooltip');
setTimeout(function(){elem.classList.remove('show-tooltip')},3000);
};
})(card1);
}
}
}
if(card2){
if(p2CardsUsed[i]){
card2.classList.add('used');
card2.innerHTML='';
card2.onclick=null;
}else{
card2.classList.remove('used');
var cardIndex=i-(5-p2Cards.length);
if(cardIndex>=0&&cardIndex<p2Cards.length){
var cardType=p2Cards[cardIndex];
var desc=cardDescriptions[cardType]||cardType.toUpperCase();
card2.innerHTML='<div class="tooltip">'+desc+'</div>';
card2.onclick=(function(elem){
return function(e){
e.stopPropagation();
document.querySelectorAll('.card-item').forEach(function(c){c.classList.remove('show-tooltip')});
elem.classList.add('show-tooltip');
setTimeout(function(){elem.classList.remove('show-tooltip')},3000);
};
})(card2);
}
}
}
}
}

function showCardReveal(player,cardType){
cardRevealQueue.push({player:player,cardType:cardType});
processCardRevealQueue();
}

function processCardRevealQueue(){
if(isShowingCardReveal||cardRevealQueue.length===0)return;
isShowingCardReveal=true;
var item=cardRevealQueue.shift();
var player=item.player;
var cardType=item.cardType;
var cardData={
'boost':{
title:'BOOST CARD',
effect:player===1?'2.5x Damage for 5 seconds':'2.5x Speed for 5 seconds',
description:player===1?'Your ball deals massive damage!':'Your ball moves at incredible speed!',
color:'linear-gradient(135deg,#FF6B6B,#FFD93D)'
},
'curse':{
title:'CURSE CARD',
effect:player===1?'60% Damage for 5 seconds':'60% Speed for 5 seconds',
description:'Bad luck! This card hurts you instead of helping.',
color:'linear-gradient(135deg,#e74c3c,#c0392b)'
},
'sabotage':{
title:'SABOTAGE CARD',
effect:player===1?'Enemy 60% Speed for 5s':'Enemy 60% Damage for 5s',
description:'Sabotage your opponent to slow them down!',
color:'linear-gradient(135deg,#8e44ad,#2c3e50)'
},
'fortify':{
title:'FORTIFY CARD',
effect:'Obstacles lose 15% HP',
description:'Instantly weaken all remaining obstacles!',
color:'linear-gradient(135deg,#27ae60,#229954)'
},
'reflect':{
title:'REFLECT CARD',
effect:'Swap active effects',
description:'Reverse any active status effects between players!',
color:'linear-gradient(135deg,#f39c12,#e67e22)'
},
'swap':{
title:'SWAP CARD',
effect:'Exchange obstacles!',
description:'Like UNO! Swap all obstacles with your opponent!',
color:'linear-gradient(135deg,#3498db,#2980b9)'
},
'stop':{
title:'STOP CARD',
effect:'Freeze enemy for 3 seconds!',
description:'Completely halt opponent\'s ball movement!',
color:'linear-gradient(135deg,#34495e,#2c3e50)'
},
'pressure':{
title:'PRESSURE CARD',
effect:'Ceiling drops 200px for 5s!',
description:'Ceiling lowers temporarily - faster bounces and more hits!',
color:'linear-gradient(135deg,#e91e63,#880e4f)'
},
'repair':{
title:'REPAIR CARD',
effect:'Enemy obstacles gain +300 HP!',
description:'Permanently increase opponent\'s obstacle health!',
color:'linear-gradient(135deg,#16a085,#1abc9c)'
},
'corrupt':{
title:'CORRUPT CARD',
effect:'Your obstacles lose -200 HP!',
description:'Bad luck! Your own obstacles become weaker!',
color:'linear-gradient(135deg,#95a5a6,#7f8c8d)'
},
'shrink':{
title:'SHRINK CARD',
effect:'Enemy ball size reduced by 30%!',
description:'Permanently shrink opponent\'s ball - less damage!',
color:'linear-gradient(135deg,#9b59b6,#8e44ad)'
},
'chaos':{
title:'CHAOS CARD',
effect:'Ball control swap for 8s!',
description:'You control opponent\'s ball temporarily!',
color:'linear-gradient(135deg,#e67e22,#d35400)'
},
'gravity':{
title:'GRAVITY CARD',
effect:'Ball gravity +10% permanent!',
description:'Increase your ball\'s fall speed permanently!',
color:'linear-gradient(135deg,#34495e,#2c3e50)'
},
'heavygravity':{
title:'HEAVY GRAVITY CARD',
effect:'Ball gravity +50% for 3 seconds!',
description:'Massive temporary speed boost!',
color:'linear-gradient(135deg,#1a1a2e,#16213e)'
},
'freeze':{
title:'FREEZE CARD ‚≠ê',
effect:'Freeze opponent for 5 seconds!',
description:'SPECIAL: Completely stop enemy ball movement!',
color:'linear-gradient(135deg,#00d2ff,#3a7bd5)'
},
'rage':{
title:'RAGE CARD ‚≠ê',
effect:player===1?'3x Damage + 2x Speed for 5s!':'3x Speed + 2x Damage for 5s!',
description:'SPECIAL: Ultimate power boost to dominate!',
color:'linear-gradient(135deg,#ff0844,#ffb199)'
},
'timewarp':{
title:'TIME WARP CARD ‚≠ê',
effect:'10x Speed for 3 seconds!',
description:'SPECIAL: Warp through time at incredible speed!',
color:'linear-gradient(135deg,#a8edea,#fed6e3)'
}
};
var card=cardData[cardType];
if(!card){
isShowingCardReveal=false;
processCardRevealQueue();
return;
}
document.getElementById('revealTitle').textContent=card.title;
document.getElementById('revealPlayer').textContent='Player '+player+' played:';
document.getElementById('revealEffect').textContent=card.effect;
document.getElementById('revealEffect').style.background=card.color;
document.getElementById('revealDescription').textContent=card.description;
var reveal=document.getElementById('cardReveal');
reveal.classList.add('show');
setTimeout(function(){
reveal.classList.remove('show');
isShowingCardReveal=false;
processCardRevealQueue();
},2000);
}

function makeObs(){
var arr=[];
for(var i=1;i<8;i++){
var randomVariation=Math.floor(Math.random()*1200)+2400;
arr.push({x:0,y:i*75+30,w:W,h:15,hp:randomVariation,maxHp:randomVariation,destroyed:0});
}
return arr;
}

function explode(ex,ey,partArr){
for(var i=0;i<15;i++){
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*3+1;
partArr.push({x:ex,y:ey,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:30,col:['#e74c3c','#f39c12','#f1c40f','#e67e22'][Math.floor(Math.random()*4)]});
}
}

function makeConfetti(colors){
for(var i=0;i<100;i++){
var px=Math.random()*cf.width;
var py=cf.height/2;
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*8+5;
confettiArr.push({
x:px,y:py,
vx:Math.cos(angle)*speed,
vy:Math.sin(angle)*speed-10,
gravity:0.4,
rotation:Math.random()*360,
rotSpeed:(Math.random()-0.5)*10,
opacity:1,
col:colors[Math.floor(Math.random()*colors.length)],
size:Math.random()*6+4
});
}
}

function drawConfetti(){
ctxConf.clearRect(0,0,cf.width,cf.height);
for(var i=confettiArr.length-1;i>=0;i--){
var part=confettiArr[i];
part.vy+=part.gravity;
part.x+=part.vx;
part.y+=part.vy;
part.rotation+=part.rotSpeed;
if(part.y>cf.height-100)part.opacity-=0.02;
ctxConf.save();
ctxConf.translate(part.x,part.y);
ctxConf.rotate(part.rotation*Math.PI/180);
ctxConf.globalAlpha=part.opacity;
ctxConf.fillStyle=part.col;
ctxConf.fillRect(-part.size/2,-part.size/2,part.size,part.size);
ctxConf.restore();
if(part.opacity<=0)confettiArr.splice(i,1);
}
if(confettiArr.length>0)requestAnimationFrame(drawConfetti);
}

function drawBall(ctx,ball){
var isMobile=window.innerWidth<768;
if(isMobile){
var lineLength=10+(ball.r-10)*3;
lineLength=Math.min(lineLength,80);
ctx.strokeStyle=ball.col;
ctx.lineWidth=6;
ctx.lineCap='round';
ctx.beginPath();
ctx.moveTo(ball.x,ball.y-lineLength/2);
ctx.lineTo(ball.x,ball.y+lineLength/2);
ctx.stroke();
}else{
ctx.fillStyle=ball.col;
ctx.beginPath();
var displayRadius=ball.r;
if(ball.type==='grow'){
displayRadius=10+Math.sqrt(ball.r-10)*8;
}
ctx.arc(ball.x,ball.y,displayRadius,0,Math.PI*2);
ctx.fill();
}
}

function drawObs(ctx,obs){
if(obs.destroyed){
if(obs.remnantW>0){
ctx.fillStyle='#34495e';
ctx.fillRect(obs.remnantX,obs.y,obs.remnantW,obs.h);
ctx.strokeStyle='#e74c3c';
ctx.lineWidth=3;
ctx.strokeRect(obs.remnantX,obs.y,obs.remnantW,obs.h);
}
return;
}
var healthPct=obs.hp/obs.maxHp;
var color=healthPct>.6?'#2ecc71':healthPct>.3?'#f39c12':'#e74c3c';
ctx.fillStyle=color;
ctx.fillRect(obs.x,obs.y,obs.w,obs.h);
ctx.strokeStyle='#2c3e50';
ctx.lineWidth=2;
ctx.strokeRect(obs.x,obs.y,obs.w,obs.h);
ctx.fillStyle='#fff';
ctx.font='10px Arial';
ctx.textAlign='center';
ctx.fillText(Math.ceil(obs.hp),obs.x+obs.w/2,obs.y+12);
}

function drawParts(ctx,partArr){
for(var i=partArr.length-1;i>=0;i--){
var pt=partArr[i];
pt.x+=pt.vx;
pt.y+=pt.vy;
pt.vx*=0.95;
pt.vy*=0.95;
pt.life--;
if(pt.text){
ctx.fillStyle=pt.col;
ctx.globalAlpha=pt.life/30;
ctx.font=(pt.isCrit?'bold 18px':'bold 14px')+' Arial';
ctx.textAlign='center';
ctx.textBaseline='middle';
ctx.strokeStyle='#000';
ctx.lineWidth=3;
ctx.strokeText(pt.text,pt.x,pt.y);
ctx.fillText(pt.text,pt.x,pt.y);
}else{
ctx.fillStyle=pt.col;
ctx.globalAlpha=pt.life/30;
ctx.beginPath();
ctx.arc(pt.x,pt.y,3,0,Math.PI*2);
ctx.fill();
}
if(pt.life<=0)partArr.splice(i,1);
}
ctx.globalAlpha=1;
}

function upd(ball,obsArr,partArr,allCleared){
if(ball===b1&&b1Stopped&&!pendingSwap)return;
if(ball===b2&&b2Stopped&&!pendingSwap)return;
var speedMultiplier=1.0;
if(ball===b2&&p2PowerupActive){
if(p2PowerupType==='boost')speedMultiplier=2.5;
else if(p2PowerupType==='curse')speedMultiplier=0.4;
else if(p2PowerupType==='mega')speedMultiplier=3.0;
else if(p2PowerupType==='warp')speedMultiplier=10.0;
else if(p2PowerupType==='heavygrav')speedMultiplier=1.5;
}
if(ball===b1&&p1PowerupActive){
if(p1PowerupType==='mega')speedMultiplier=2.0;
else if(p1PowerupType==='warp')speedMultiplier=10.0;
else if(p1PowerupType==='heavygrav')speedMultiplier=1.5;
}
var activeCeiling=ball===b1?ceiling1:ceiling2;
var totalHp1=0,totalHp2=0;
for(var i=0;i<o1.length;i++)totalHp1+=o1[i].maxHp;
for(var i=0;i<o2.length;i++)totalHp2+=o2[i].maxHp;
var progress1=(b1.totalDmg/totalHp1)*100;
var progress2=(b2.totalDmg/totalHp2)*100;
var finalStretch=progress1>85||progress2>85;
if(finalStretch){
if(Math.random()<0.08){
ball.vy*=1.5;
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*3+2;
partArr.push({x:ball.x,y:ball.y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:20,col:'#FFD700'});
}
}
ball.x+=ball.vx;
var oldY=ball.y;
var maxStep=8;
var steps=Math.ceil(Math.abs(ball.vy*speedMultiplier)/maxStep);
var stepVy=(ball.vy*speedMultiplier)/steps;
for(var step=0;step<steps;step++){
ball.y+=stepVy;
if(ball.y<ball.r+activeCeiling){
ball.y=ball.r+activeCeiling;
ball.vy=Math.abs(ball.vy);
if(activeCeiling>20){
ball.vy+=5;
}
}
if(ball.y+ball.r>=H){
if(allCleared){
ball.y+=stepVy;
}else{
ball.y=H-ball.r-1;
if(ball.type==='speed'){
ball.vy=-Math.abs(ball.vy)*0.8;
}else{
ball.vy=-Math.abs(ball.vy)*0.7;
}
if(activeCeiling>20){
ball.vy=-(Math.abs(ball.vy)+8);
}
}
break;
}
if(pendingSwap){
ball.y+=stepVy;
continue;
}
var hitObs=false;
for(var i=0;i<obsArr.length;i++){
var obs=obsArr[i];
if(obs.destroyed)continue;
if(ball.y+ball.r>obs.y&&ball.y-ball.r<obs.y+obs.h&&ball.x+ball.r>obs.x&&ball.x-ball.r<obs.x+obs.w){
var totalHp1=0,totalHp2=0;
for(var k=0;k<o1.length;k++)totalHp1+=o1[k].maxHp;
for(var k=0;k<o2.length;k++)totalHp2+=o2[k].maxHp;
var progress1=(b1.totalDmg/totalHp1)*100;
var progress2=(b2.totalDmg/totalHp2)*100;
var comebackBonus=1.0;
if(ball===b1&&progress1<progress2-10){
comebackBonus=1.15;
}else if(ball===b2&&progress2<progress1-10){
comebackBonus=1.15;
}
var isCrit=Math.random()<0.15;
var randomDmgMultiplier=isCrit?1.5:(0.8+Math.random()*0.2);
var powerupBonus=1.0;
if(ball===b1&&p1PowerupActive){
if(p1PowerupType==='boost')powerupBonus=2.5;
else if(p1PowerupType==='curse')powerupBonus=0.4;
else if(p1PowerupType==='mega')powerupBonus=3.0;
}
if(ball===b2&&p2PowerupActive){
if(p2PowerupType==='mega')powerupBonus=2.0;
}
var actualDmg=ball.dmg*randomDmgMultiplier*comebackBonus*powerupBonus;
var dmgDealt=Math.min(actualDmg,obs.hp);
ball.totalDmg+=dmgDealt;
obs.hp-=actualDmg;
partArr.push({x:ball.x,y:obs.y+obs.h/2,vx:0,vy:-2,life:30,col:isCrit?'#FFD700':'#fff',text:'-'+Math.ceil(dmgDealt),isCrit:isCrit});
if(isCrit){
if(ball===b1){
c1.classList.add('crit-flash');
setTimeout(function(){c1.classList.remove('crit-flash')},300);
for(var j=0;j<8;j++){
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*4+2;
partArr.push({x:ball.x,y:obs.y+obs.h/2,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:20,col:'#FFD700'});
}
if(Date.now()-lastCritTime1>3000){
showCommentary(getCritReaction(),'p1');
lastCritTime1=Date.now();
}
}else{
c2.classList.add('crit-flash');
setTimeout(function(){c2.classList.remove('crit-flash')},300);
for(var j=0;j<8;j++){
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*4+2;
partArr.push({x:ball.x,y:obs.y+obs.h/2,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:20,col:'#FFD700'});
}
if(Date.now()-lastCritTime2>3000){
showCommentary(getCritReaction(),'p2');
lastCritTime2=Date.now();
}
}
}else{
for(var j=0;j<3;j++){
var angle=Math.random()*Math.PI*2;
var speed=Math.random()*2+1;
partArr.push({x:ball.x,y:obs.y+obs.h/2,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:15,col:'#95a5a6'});
}
}
if(obs.hp<=0){
obs.hp=0;
obs.destroyed=1;
explode(obs.x+obs.w/2,obs.y+obs.h/2,partArr);
}
if(obs.hp>0){
var fromTop=ball.y<obs.y+obs.h/2;
if(fromTop){
ball.vy=-Math.abs(ball.vy);
ball.y=obs.y-ball.r;
}else{
ball.vy=Math.abs(ball.vy);
ball.y=obs.y+obs.h+ball.r;
}
}
if(ball.type==='speed'){
var speedBoost=0.05+(Math.random()-0.5)*0.01;
ball.vy=ball.vy>0?(Math.abs(ball.vy)+speedBoost):(-(Math.abs(ball.vy)+speedBoost));
var maxSpeed=20;
if(Math.abs(ball.vy)>maxSpeed){
ball.vy=ball.vy>0?maxSpeed:-maxSpeed;
}
var damageBoost=0.01+(Math.random()-0.5)*0.002;
ball.dmg+=damageBoost;
}else{
var growthRate=1.009+(Math.random()-0.5)*0.001;
ball.r=ball.r*growthRate;
ball.dmg=ball.r*5;
ball.vy=ball.vy>0?5:-5;
}
ball.bounces++;
hitObs=true;
break;
}
}
if(hitObs)break;
}
if(ball.y+ball.r>=H&&!allCleared){
ball.y=H-ball.r-1;
if(ball.type==='speed'){
ball.vy=-Math.abs(ball.vy)*0.8;
}else{
ball.vy=-Math.abs(ball.vy)*0.7;
}
}
ball.vx*=0.99;
if(ball.type!=='speed'){
if(Math.abs(ball.vy)!=5)ball.vy=ball.vy>0?5:-5;
}
if(Math.abs(ball.vx)>10)ball.vx=ball.vx>0?10:-10;
if(Math.abs(ball.y-ball.lastY)<3){
ball.stuckCount++;
if(ball.stuckCount>8){
ball.vx=(Math.random()-0.5)*8;
if(ball.type==='speed'){
ball.vy=Math.abs(ball.vy)+8;
}else{
ball.vy=ball.vy>0?5:-5;
}
ball.y+=15;
ball.stuckCount=0;
}
}else{
ball.stuckCount=0;
}
ball.lastY=oldY;
if(ball.x<ball.r||ball.x>W-ball.r){
ball.vx*=-0.85;
ball.x=Math.max(ball.r,Math.min(W-ball.r,ball.x));
if(ball.r>25)ball.vx*=0.6;
}
}

function usePowerup(player){
if(player===1){
if(p1Cards.length===0)return;
var cardType=p1Cards.shift();
showCardReveal(1,cardType);
var cardMessages={
'boost':'2.5x Damage for 5 seconds',
'curse':'60% Damage for 5 seconds (Bad luck!)',
'sabotage':'Enemy 60% Speed for 5s',
'fortify':'Obstacles lose 15% HP',
'reflect':'Swap active effects',
'swap':'Exchange obstacles!',
'stop':'Freeze enemy ball for 3s!',
'pressure':'Ceiling drops 200px for 5s!',
'repair':'Enemy obstacles gain +300 HP!',
'corrupt':'Your obstacles weakened -200 HP!',
'shrink':'Enemy ball size reduced by 30%!',
'chaos':'Random ball swap for 8s!',
'gravity':'Ball gravity +10% permanent!',
'heavygravity':'Ball fall speed +50% for 3s!',
'freeze':'‚≠ê Freeze enemy for 5s!',
'rage':'‚≠ê 3x Damage + 2x Speed for 5s!',
'timewarp':'‚≠ê 10x Speed for 3s!'
};
logEvent(cardMessages[cardType]||cardType,'p1',cardType);
updateCardDisplay();
p1PowerupType=cardType;
p1PowerupActive=true;
p1PowerupEnd=Date.now()+5000;
if(cardType==='curse'){
document.getElementById('powerup1').textContent='CURSED! 60% Damage';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#e74c3c,#c0392b)';
}else if(cardType==='sabotage'){
p2PowerupType='curse';
p2PowerupActive=true;
p2PowerupEnd=Date.now()+5000;
document.getElementById('powerup1').textContent='SABOTAGE! Enemy Slowed';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#8e44ad,#2c3e50)';
document.getElementById('powerup2').textContent='SABOTAGED! 60% Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#e74c3c,#c0392b)';
document.getElementById('powerup2').style.display='block';
setTimeout(function(){document.getElementById('powerup2').style.display='none'},5000);
setTimeout(function(){showCommentary('Big Belly: "What just happened?!" üò≠','p1')},500);
}else if(cardType==='fortify'){
for(var i=0;i<o1.length;i++){
if(!o1[i].destroyed){
o1[i].hp=Math.max(o1[i].hp-o1[i].maxHp*0.15,o1[i].maxHp*0.1);
}
}
document.getElementById('powerup1').textContent='FORTIFY! Obstacles Weakened';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#27ae60,#229954)';
p1PowerupActive=false;
}else if(cardType==='reflect'){
var temp=p1PowerupType;
p1PowerupType=p2PowerupType;
p2PowerupType=temp;
document.getElementById('powerup1').textContent='REFLECT! Effects Swapped';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#f39c12,#e67e22)';
p1PowerupActive=false;
}else if(cardType==='swap'){
pendingSwap=true;
swapInitiator=1;
document.getElementById('powerup1').textContent='SWAP! Waiting for safe position...';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#3498db,#2980b9)';
p1PowerupActive=false;
setTimeout(function(){showCommentary('Speedy: "UNO reverse!" üé¥','p1')},300);
}else if(cardType==='stop'){
b2Stopped=true;
stopEnd2=Date.now()+3000;
b2.vy=0;
b2.vx=0;
document.getElementById('powerup1').textContent='STOP! Enemy Frozen 3s';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
document.getElementById('powerup2').textContent='STOPPED! Frozen 3s';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
document.getElementById('powerup2').style.display='block';
p1PowerupActive=false;
}else if(cardType==='pressure'){
if(ceiling1<=20){
ceiling1=220;
ceilingEnd1=Date.now()+5000;
if(b1.y<b1.r+ceiling1){
b1.y=b1.r+ceiling1;
b1.vy=Math.abs(b1.vy)+3;
}
document.getElementById('powerup1').textContent='PRESSURE! Ceiling Lowered';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#e91e63,#880e4f)';
}else{
document.getElementById('powerup1').textContent='Ceiling Already Active!';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#95a5a6,#7f8c8d)';
p1PowerupActive=false;
}
}else if(cardType==='repair'){
for(var i=0;i<o2.length;i++){
if(!o2[i].destroyed){
o2[i].hp+=300;
o2[i].maxHp+=300;
originalTotalHp2+=300;
}
}
document.getElementById('powerup1').textContent='REPAIR! Enemy +300 HP';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#16a085,#1abc9c)';
p1PowerupActive=false;
}else if(cardType==='corrupt'){
for(var i=0;i<o1.length;i++){
if(!o1[i].destroyed){
o1[i].hp=Math.max(1,o1[i].hp-200);
}
}
document.getElementById('powerup1').textContent='CORRUPT! Own -200 HP';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#95a5a6,#7f8c8d)';
p1PowerupActive=false;
}else if(cardType==='shrink'){
b2.r*=0.7;
b2.dmg*=0.7;
document.getElementById('powerup1').textContent='SHRINK! Enemy -30% Size';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#9b59b6,#8e44ad)';
p1PowerupActive=false;
setTimeout(function(){showCommentary('Speedy: "Size matters, buddy!" üòà','p1')},400);
}else if(cardType==='chaos'){
chaosActive=true;
chaosEnd=Date.now()+8000;
chaosInitiator=1;
document.getElementById('powerup1').textContent='CHAOS! Ball Control Swapped';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#e67e22,#d35400)';
p1PowerupActive=false;
}else if(cardType==='gravity'){
b1.vy*=1.1;
document.getElementById('powerup1').textContent='GRAVITY! +10% Fall Speed';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
p1PowerupActive=false;
}else if(cardType==='heavygravity'){
p1PowerupType='heavygrav';
p1PowerupActive=true;
p1PowerupEnd=Date.now()+3000;
document.getElementById('powerup1').textContent='HEAVY GRAVITY! +50% Fall Speed';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#1a1a2e,#16213e)';
}else if(cardType==='freeze'){
b2Stopped=true;
stopEnd2=Date.now()+5000;
b2.vy=0;
b2.vx=0;
document.getElementById('powerup1').textContent='‚≠ê FREEZE! Enemy Frozen 5s';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#00d2ff,#3a7bd5)';
document.getElementById('powerup2').textContent='FROZEN! Can\'t move 5s';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#00d2ff,#3a7bd5)';
document.getElementById('powerup2').style.display='block';
p1PowerupActive=false;
setTimeout(function(){showCommentary('Speedy: "Chill out!" ‚ùÑÔ∏è','p1')},600);
}else if(cardType==='rage'){
p1PowerupType='mega';
p1PowerupActive=true;
p1PowerupEnd=Date.now()+5000;
document.getElementById('powerup1').textContent='‚≠ê RAGE! 3x Damage + 2x Speed';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#ff0844,#ffb199)';
}else if(cardType==='timewarp'){
p1PowerupType='warp';
p1PowerupActive=true;
p1PowerupEnd=Date.now()+3000;
document.getElementById('powerup1').textContent='‚≠ê TIME WARP! 10x Speed';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#a8edea,#fed6e3)';
}else{
document.getElementById('powerup1').textContent='BOOST! 2.5x Damage';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#FF6B6B,#FFD93D)';
}
document.getElementById('powerup1').style.display='block';
setTimeout(function(){document.getElementById('powerup1').style.display='none'},5000);
}else if(player===2){
if(p2Cards.length===0)return;
var cardType=p2Cards.shift();
showCardReveal(2,cardType);
var cardMessages={
'boost':'2.5x Speed for 5 seconds',
'curse':'60% Speed for 5 seconds (Bad luck!)',
'sabotage':'Enemy 60% Damage for 5s',
'fortify':'Obstacles lose 15% HP',
'reflect':'Swap active effects',
'swap':'Exchange obstacles!',
'stop':'Freeze enemy ball for 3s!',
'pressure':'Ceiling drops 200px for 5s!',
'repair':'Enemy obstacles gain +300 HP!',
'corrupt':'Your obstacles weakened -200 HP!',
'shrink':'Enemy ball size reduced by 30%!',
'chaos':'Random ball swap for 8s!',
'gravity':'Ball gravity +10% permanent!',
'heavygravity':'Ball fall speed +50% for 3s!',
'freeze':'‚≠ê Freeze enemy for 5s!',
'rage':'‚≠ê 3x Speed + 2x Damage for 5s!',
'timewarp':'‚≠ê 10x Speed for 3s!'
};
logEvent(cardMessages[cardType]||cardType,'p2',cardType);
updateCardDisplay();
p2PowerupType=cardType;
p2PowerupActive=true;
p2PowerupEnd=Date.now()+5000;
if(cardType==='curse'){
document.getElementById('powerup2').textContent='CURSED! 60% Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#e74c3c,#c0392b)';
}else if(cardType==='sabotage'){
p1PowerupType='curse';
p1PowerupActive=true;
p1PowerupEnd=Date.now()+5000;
document.getElementById('powerup2').textContent='SABOTAGE! Enemy Weakened';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#8e44ad,#2c3e50)';
document.getElementById('powerup1').textContent='SABOTAGED! 60% Damage';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#e74c3c,#c0392b)';
document.getElementById('powerup1').style.display='block';
setTimeout(function(){document.getElementById('powerup1').style.display='none'},5000);
setTimeout(function(){showCommentary('Speedy: "Not fair!" üò§','p2')},500);
}else if(cardType==='fortify'){
for(var i=0;i<o2.length;i++){
if(!o2[i].destroyed){
o2[i].hp=Math.max(o2[i].hp-o2[i].maxHp*0.15,o2[i].maxHp*0.1);
}
}
document.getElementById('powerup2').textContent='FORTIFY! Obstacles Weakened';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#27ae60,#229954)';
p2PowerupActive=false;
}else if(cardType==='reflect'){
var temp=p1PowerupType;
p1PowerupType=p2PowerupType;
p2PowerupType=temp;
document.getElementById('powerup2').textContent='REFLECT! Effects Swapped';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#f39c12,#e67e22)';
p2PowerupActive=false;
}else if(cardType==='swap'){
pendingSwap=true;
swapInitiator=2;
document.getElementById('powerup2').textContent='SWAP! Waiting for safe position...';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#3498db,#2980b9)';
p2PowerupActive=false;
setTimeout(function(){showCommentary('Big Belly: "Trade ya!" üîÑ','p2')},300);
}else if(cardType==='stop'){
b1Stopped=true;
stopEnd1=Date.now()+3000;
b1.vy=0;
b1.vx=0;
document.getElementById('powerup2').textContent='STOP! Enemy Frozen 3s';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
document.getElementById('powerup1').textContent='STOPPED! Frozen 3s';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
document.getElementById('powerup1').style.display='block';
p2PowerupActive=false;
}else if(cardType==='pressure'){
if(ceiling2<=20){
ceiling2=220;
ceilingEnd2=Date.now()+5000;
if(b2.y<b2.r+ceiling2){
b2.y=b2.r+ceiling2;
b2.vy=Math.abs(b2.vy)+3;
}
document.getElementById('powerup2').textContent='PRESSURE! Ceiling Lowered';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#e91e63,#880e4f)';
}else{
document.getElementById('powerup2').textContent='Ceiling Already Active!';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#95a5a6,#7f8c8d)';
p2PowerupActive=false;
}
}else if(cardType==='repair'){
for(var i=0;i<o1.length;i++){
if(!o1[i].destroyed){
o1[i].hp+=300;
o1[i].maxHp+=300;
originalTotalHp1+=300;
}
}
document.getElementById('powerup2').textContent='REPAIR! Enemy +300 HP';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#16a085,#1abc9c)';
p2PowerupActive=false;
}else if(cardType==='corrupt'){
for(var i=0;i<o2.length;i++){
if(!o2[i].destroyed){
o2[i].hp=Math.max(1,o2[i].hp-200);
}
}
document.getElementById('powerup2').textContent='CORRUPT! Own -200 HP';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#95a5a6,#7f8c8d)';
p2PowerupActive=false;
}else if(cardType==='shrink'){
b1.r*=0.7;
b1.dmg*=0.7;
document.getElementById('powerup2').textContent='SHRINK! Enemy -30% Size';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#9b59b6,#8e44ad)';
p2PowerupActive=false;
setTimeout(function(){showCommentary('Big Belly: "Small things, big trouble!" üëπ','p2')},400);
}else if(cardType==='chaos'){
chaosActive=true;
chaosEnd=Date.now()+8000;
chaosInitiator=2;
document.getElementById('powerup2').textContent='CHAOS! Ball Control Swapped';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#e67e22,#d35400)';
p2PowerupActive=false;
}else if(cardType==='gravity'){
b2.vy*=1.1;
document.getElementById('powerup2').textContent='GRAVITY! +10% Fall Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#34495e,#2c3e50)';
p2PowerupActive=false;
}else if(cardType==='heavygravity'){
p2PowerupType='heavygrav';
p2PowerupActive=true;
p2PowerupEnd=Date.now()+3000;
document.getElementById('powerup2').textContent='HEAVY GRAVITY! +50% Fall Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#1a1a2e,#16213e)';
}else if(cardType==='freeze'){
b1Stopped=true;
stopEnd1=Date.now()+5000;
b1.vy=0;
b1.vx=0;
document.getElementById('powerup2').textContent='‚≠ê FREEZE! Enemy Frozen 5s';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#00d2ff,#3a7bd5)';
document.getElementById('powerup1').textContent='FROZEN! Can\'t move 5s';
document.getElementById('powerup1').style.background='linear-gradient(135deg,#00d2ff,#3a7bd5)';
document.getElementById('powerup1').style.display='block';
p2PowerupActive=false;
setTimeout(function(){showCommentary('Big Belly: "Ice ice baby!" üßä','p2')},600);
}else if(cardType==='rage'){
p2PowerupType='mega';
p2PowerupActive=true;
p2PowerupEnd=Date.now()+5000;
document.getElementById('powerup2').textContent='‚≠ê RAGE! 3x Speed + 2x Damage';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#ff0844,#ffb199)';
}else if(cardType==='timewarp'){
p2PowerupType='warp';
p2PowerupActive=true;
p2PowerupEnd=Date.now()+3000;
document.getElementById('powerup2').textContent='‚≠ê TIME WARP! 10x Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#a8edea,#fed6e3)';
}else{
document.getElementById('powerup2').textContent='BOOST! 2.5x Speed';
document.getElementById('powerup2').style.background='linear-gradient(135deg,#FF6B6B,#FFD93D)';
}
document.getElementById('powerup2').style.display='block';
setTimeout(function(){document.getElementById('powerup2').style.display='none'},5000);
}
}

function checkPowerupAI(){
var progress1=(b1.totalDmg/originalTotalHp1)*100;
var progress2=(b2.totalDmg/originalTotalHp2)*100;
var diff=Math.abs(progress1-progress2);
if(!closeRaceLogged&&progress1>30&&progress2>30&&diff<10){
var comment=getCloseRaceComment(diff);
if(comment){
showCommentary(comment,'system');
closeRaceLogged=true;
}
}
var instantCards=['fortify','reflect','swap','repair','corrupt','shrink','gravity','freeze'];
var isLosing1=progress1<progress2-10;
var isLosing2=progress2<progress1-10;
if(isLosing1&&p1Cards.length>0&&!p1CardsUsed[4]){
p1CardsUsed[4]=true;
var lastCard=p1Cards[p1Cards.length-1];
p1Cards.splice(p1Cards.length-1,1);
p1Cards.unshift(lastCard);
logEvent('üîÑ Desperation! Playing special card','p1');
usePowerup(1);
p1InstantCooldown=Date.now()+3000;
updateCardDisplay();
}
if(isLosing2&&p2Cards.length>0&&!p2CardsUsed[4]){
p2CardsUsed[4]=true;
var lastCard=p2Cards[p2Cards.length-1];
p2Cards.splice(p2Cards.length-1,1);
p2Cards.unshift(lastCard);
logEvent('üîÑ Desperation! Playing special card','p2');
usePowerup(2);
p2InstantCooldown=Date.now()+3000;
updateCardDisplay();
}
for(var i=0;i<5;i++){
var milestoneRange=CARD_MILESTONES[i];
var minMilestone=milestoneRange[0];
var maxMilestone=milestoneRange[1];
if(progress1>=minMilestone&&progress1<=maxMilestone&&!p1CardsUsed[i]){
if(p1Cards.length>0){
var cardType=p1Cards[0];
var isInstant=instantCards.indexOf(cardType)!==-1;
var isLosing=progress1<progress2-10;
var isWinning=progress1>progress2+10;
var canUse=!p2PowerupActive||isInstant||isLosing;
var onCooldown=Date.now()<p1InstantCooldown;
if(isWinning&&i<4){
p1CardsUsed[i]=true;
p1Cards.shift();
updateCardDisplay();
logEvent('üí° Skipped card','p1');
break;
}else if(onCooldown){
break;
}else if(canUse){
p1CardsUsed[i]=true;
usePowerup(1);
p1InstantCooldown=Date.now()+3000;
updateCardDisplay();
break;
}
}else{
p1CardsUsed[i]=true;
}
}else if(progress1>maxMilestone&&!p1CardsUsed[i]){
p1CardsUsed[i]=true;
p1Cards.shift();
updateCardDisplay();
logEvent('Card lost - missed timing','p1',p1Cards.length>0?p1Cards[0]:'');
break;
}
}
for(var i=0;i<5;i++){
var milestoneRange=CARD_MILESTONES[i];
var minMilestone=milestoneRange[0];
var maxMilestone=milestoneRange[1];
if(progress2>=minMilestone&&progress2<=maxMilestone&&!p2CardsUsed[i]){
if(p2Cards.length>0){
var cardType=p2Cards[0];
var isInstant=instantCards.indexOf(cardType)!==-1;
var isLosing=progress2<progress1-10;
var isWinning=progress2>progress1+10;
var canUse=!p1PowerupActive||isInstant||isLosing;
var onCooldown=Date.now()<p2InstantCooldown;
if(isWinning&&i<4){
p2CardsUsed[i]=true;
p2Cards.shift();
updateCardDisplay();
logEvent('üí° Skipped card','p2');
break;
}else if(onCooldown){
break;
}else if(canUse){
p2CardsUsed[i]=true;
usePowerup(2);
p2InstantCooldown=Date.now()+3000;
updateCardDisplay();
break;
}
}else{
p2CardsUsed[i]=true;
}
}else if(progress2>maxMilestone&&!p2CardsUsed[i]){
p2CardsUsed[i]=true;
p2Cards.shift();
updateCardDisplay();
logEvent('Card lost - missed timing','p2',p2Cards.length>0?p2Cards[0]:'');
break;
}
}
if(p1PowerupActive&&Date.now()>p1PowerupEnd)p1PowerupActive=false;
if(p2PowerupActive&&Date.now()>p2PowerupEnd)p2PowerupActive=false;
}

function updateStats(){
speedHistory1.push(Math.abs(b1.vy)/5);
if(speedHistory1.length>SPEED_SMOOTH_FRAMES)speedHistory1.shift();
var avgSpeed1=speedHistory1.reduce(function(a,b){return a+b},0)/speedHistory1.length;
document.getElementById('sp1').textContent=avgSpeed1.toFixed(2)+'x';
var dmg1Text=b1.dmg.toFixed(1);
var isMobile=window.innerWidth<768;
if(p1PowerupActive)dmg1Text+=isMobile?' \u26A1':' (+'+((b1.dmg*2.5).toFixed(1))+' \u26A1)';
document.getElementById('dm1').textContent=dmg1Text;
document.getElementById('bn1').textContent=b1.bounces;
var progress1=Math.min(100,(b1.totalDmg/originalTotalHp1)*100);
var progress2=Math.min(100,(b2.totalDmg/originalTotalHp2)*100);
var total=progress1+progress2;
var p1Width=total>0?(progress1/total)*100:50;
var p2Width=total>0?(progress2/total)*100:50;
document.getElementById('progbar1').style.width=p1Width+'%';
document.getElementById('progbar2').style.width=p2Width+'%';
document.getElementById('progtext1').textContent=progress1.toFixed(1)+'%';
speedHistory2.push(Math.abs(b2.vy)/5);
if(speedHistory2.length>SPEED_SMOOTH_FRAMES)speedHistory2.shift();
var avgSpeed2=speedHistory2.reduce(function(a,b){return a+b},0)/speedHistory2.length;
var speed2Text=avgSpeed2.toFixed(2)+'x';
if(p2PowerupActive)speed2Text+=isMobile?' \u26A1':' (+'+(avgSpeed2*2.5).toFixed(2)+'x \u26A1)';
document.getElementById('sp2').textContent=speed2Text;
document.getElementById('dm2').textContent=b2.dmg.toFixed(1);
document.getElementById('bn2').textContent=b2.bounces;
document.getElementById('progtext2').textContent=progress2.toFixed(1)+'%';
}

function draw(){
if(!run||win||isPaused)return;
gameTime=(Date.now()-startTime-totalPausedTime)/1000;
document.getElementById('timerText').textContent=gameTime.toFixed(1);
ctx1.clearRect(0,0,W,H);
ctx2.clearRect(0,0,W,H);
if(b1Stopped&&Date.now()>stopEnd1){
b1Stopped=false;
document.getElementById('powerup1').style.display='none';
}
if(b2Stopped&&Date.now()>stopEnd2){
b2Stopped=false;
document.getElementById('powerup2').style.display='none';
}
if(pendingSwap){
if(!b1Stopped&&!b2Stopped){
b1Stopped=true;
b2Stopped=true;
b1.vy=-3;
b1.vx=0;
b2.vy=-3;
b2.vx=0;
}
var b1AtTop=b1.y<150;
var b2AtTop=b2.y<150;
if(b1AtTop&&b2AtTop){
var tempObs=o1;
o1=o2;
o2=tempObs;
var tempHp=originalTotalHp1;
originalTotalHp1=originalTotalHp2;
originalTotalHp2=tempHp;
var tempDmg=b1.totalDmg;
b1.totalDmg=b2.totalDmg;
b2.totalDmg=tempDmg;
pendingSwap=false;
b1Stopped=false;
b2Stopped=false;
if(swapInitiator===1){
document.getElementById('powerup1').textContent='SWAP! Obstacles Exchanged';
document.getElementById('powerup1').style.display='block';
setTimeout(function(){document.getElementById('powerup1').style.display='none'},3000);
}else{
document.getElementById('powerup2').textContent='SWAP! Obstacles Exchanged';
document.getElementById('powerup2').style.display='block';
setTimeout(function(){document.getElementById('powerup2').style.display='none'},3000);
}
}
}
if(chaosActive&&Date.now()>chaosEnd){
chaosActive=false;
}
var allObs1Cleared=true;
for(var i=0;i<o1.length;i++){
if(!o1[i].destroyed){allObs1Cleared=false;break;}
}
var allObs2Cleared=true;
for(var i=0;i<o2.length;i++){
if(!o2[i].destroyed){allObs2Cleared=false;break;}
}
upd(b1,o1,p1,allObs1Cleared);
upd(b2,o2,p2,allObs2Cleared);
checkPowerupAI();
if(ceiling1>20&&Date.now()>ceilingEnd1)ceiling1=20;
if(ceiling2>20&&Date.now()>ceilingEnd2)ceiling2=20;
if(ceiling1>20){
ctx1.fillStyle='rgba(231,76,60,0.3)';
ctx1.fillRect(0,0,W,ceiling1);
ctx1.strokeStyle='#e74c3c';
ctx1.lineWidth=3;
ctx1.strokeRect(0,ceiling1-3,W,3);
}
if(ceiling2>20){
ctx2.fillStyle='rgba(231,76,60,0.3)';
ctx2.fillRect(0,0,W,ceiling2);
ctx2.strokeStyle='#e74c3c';
ctx2.lineWidth=3;
ctx2.strokeRect(0,ceiling2-3,W,3);
}
for(var i=0;i<o1.length;i++)drawObs(ctx1,o1[i]);
for(var i=0;i<o2.length;i++)drawObs(ctx2,o2[i]);
drawParts(ctx1,p1);
drawParts(ctx2,p2);
drawBall(ctx1,b1);
drawBall(ctx2,b2);
updateStats();
if(b1.y>=H-50&&allObs1Cleared&&!win){
win='Speedy Wins!';
run=0;
p1Wins++;
totalRaces++;
gameTime=(Date.now()-startTime)/1000;
showCommentary(getRandomWinMessage('Speedy','Big Belly',gameTime),'p1');
document.getElementById('winner1').classList.add('show');
document.getElementById('p1wins').textContent=p1Wins;
document.getElementById('p2wins').textContent=p2Wins;
document.getElementById('powerup1').style.display='none';
document.getElementById('powerup2').style.display='none';
makeConfetti(['#667eea','#764ba2','#FFD700','#FFF']);
drawConfetti();
setTimeout(reset,3000);
}else if(b2.y>=H-50&&allObs2Cleared&&!win){
win='Big Belly Wins!';
run=0;
p2Wins++;
totalRaces++;
gameTime=(Date.now()-startTime)/1000;
showCommentary(getRandomWinMessage('Big Belly','Speedy',gameTime),'p2');
document.getElementById('winner2').classList.add('show');
document.getElementById('p1wins').textContent=p1Wins;
document.getElementById('p2wins').textContent=p2Wins;
document.getElementById('powerup1').style.display='none';
document.getElementById('powerup2').style.display='none';
makeConfetti(['#f093fb','#f5576c','#FFD700','#FFF']);
drawConfetti();
setTimeout(reset,3000);
}
if(run)requestAnimationFrame(draw);
}

function reset(){
p1PowerupActive=false;
p2PowerupActive=false;
p1InstantCooldown=0;
p2InstantCooldown=0;
isPaused=false;
totalPausedTime=0;
ceiling1=20;
ceiling2=20;
ceilingEnd1=0;
ceilingEnd2=0;
pendingSwap=false;
swapInitiator=0;
b1Stopped=false;
b2Stopped=false;
stopEnd1=0;
stopEnd2=0;
chaosActive=false;
chaosEnd=0;
chaosInitiator=0;
cardRevealQueue=[];
isShowingCardReveal=false;
closeRaceLogged=false;
lastCritTime1=0;
lastCritTime2=0;
speedHistory1=[];
speedHistory2=[];
document.getElementById('powerup1').style.display='none';
document.getElementById('powerup2').style.display='none';
var startX1=130+Math.random()*40;
var startX2=130+Math.random()*40;
var startVy1=sp1+(Math.random()-0.5)*0.5;
var startVy2=sp2+(Math.random()-0.5)*0.5;
b1={x:startX1,y:50,vx:0,vy:startVy1,r:10,col:'#667eea',dmg:50,bounces:0,sm:1,type:'speed',lastY:50,stuckCount:0,totalDmg:0};
b2={x:startX2,y:50,vx:0,vy:startVy2,r:10,col:'#f5576c',dmg:50,bounces:0,sm:1,type:'grow',lastY:50,stuckCount:0,totalDmg:0};
o1=makeObs();
o2=makeObs();
originalTotalHp1=0;
originalTotalHp2=0;
for(var i=0;i<o1.length;i++)originalTotalHp1+=o1[i].maxHp;
for(var i=0;i<o2.length;i++)originalTotalHp2+=o2[i].maxHp;
p1=[];
p2=[];
confettiArr=[];
ctxConf.clearRect(0,0,cf.width,cf.height);
win='';
run=0;
gameTime=0;
startRace();
}

document.addEventListener('keydown',function(e){
if(e.key==='q'||e.key==='Q'){
if(p1Cards.length>0&&!win){
usePowerup(1);
}
}
if(e.key==='p'||e.key==='P'){
if(p2Cards.length>0&&!win){
usePowerup(2);
}
}
});

document.addEventListener('click',function(e){
if(!e.target.closest('.card-item')){
document.querySelectorAll('.card-item').forEach(function(c){c.classList.remove('show-tooltip')});
}
});

document.addEventListener('visibilitychange',function(){
if(document.hidden&&run&&!win&&!isPaused){
togglePause();
}
});

generateCards();
o1=makeObs();
o2=makeObs();
originalTotalHp1=0;
originalTotalHp2=0;
for(var i=0;i<o1.length;i++)originalTotalHp1+=o1[i].maxHp;
for(var i=0;i<o2.length;i++)originalTotalHp2+=o2[i].maxHp;
run=0;
startRace();

function togglePause(){
if(win)return;
isPaused=!isPaused;
var pauseBtn=document.getElementById('pauseBtn');
if(isPaused){
if(countdown>0){
clearInterval(countdownInterval);
}
pauseStartTime=Date.now();
pauseBtn.textContent='‚ñ∂';
pauseBtn.style.background='#27ae60';
}else{
if(countdown>0){
var timerBox=document.getElementById('timerBox');
countdownInterval=setInterval(function(){
countdown--;
document.getElementById('timerText').textContent=countdown;
if(countdown<=0){
clearInterval(countdownInterval);
generateCards();
document.getElementById('timelineCenter').innerHTML='';
document.getElementById('winner1').classList.remove('show');
document.getElementById('winner2').classList.remove('show');
run=1;
isPaused=false;
startTime=Date.now();
timerBox.style.background='#fff';
timerBox.style.color='#333';
draw();
}
},1000);
}else{
totalPausedTime+=Date.now()-pauseStartTime;
}
pauseBtn.textContent='‚è∏';
pauseBtn.style.background='#34495e';
draw();
}
}

function getCountdownTrashTalk(){
var messages=[
{player:'p1',text:`Speedy: "Ready to eat my dust?" üí®`},
{player:'p2',text:`Big Belly: "I'm gonna crush you!" üí™`},
{player:'p1',text:`Speedy: "Speed kills, buddy!" ‚ö°`},
{player:'p2',text:`Big Belly: "Slow and steady wins!" üê¢`},
{player:'p1',text:`Speedy: "Can't catch what you can't see!" üëª`},
{player:'p2',text:`Big Belly: "Size matters!" üò§`},
{player:'p1',text:`Speedy: "I was born ready!" üòé`},
{player:'p2',text:`Big Belly: "Bring it on!" üî•`}
];
return messages[Math.floor(Math.random()*messages.length)];
}

function startRace(){
countdown=10;
var timerBox=document.getElementById('timerBox');
timerBox.style.background='linear-gradient(135deg,#667eea,#f5576c)';
timerBox.style.color='#fff';
var trashTalkShown=false;
countdownInterval=setInterval(function(){
countdown--;
document.getElementById('timerText').textContent=countdown;
if(countdown===7&&!trashTalkShown){
var trash=getCountdownTrashTalk();
showCommentary(trash.text,trash.player);
trashTalkShown=true;
}
if(countdown===3){
var trash2=getCountdownTrashTalk();
showCommentary(trash2.text,trash2.player);
}
if(countdown<=0){
clearInterval(countdownInterval);
generateCards();
document.getElementById('timelineCenter').innerHTML='';
document.getElementById('winner1').classList.remove('show');
document.getElementById('winner2').classList.remove('show');
run=1;
isPaused=false;
startTime=Date.now();
timerBox.style.background='#fff';
timerBox.style.color='#333';
totalPausedTime=0;
draw();
}
},1000);
}

</script>
</body>
</html>
